<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motia Smart PDF</title>
    <style>
        body {
            font-family: -apple-system, system-ui, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        textarea {
            width: 100%;
            height: 100px;
            padding: 0.5rem;
        }

        button {
            padding: 0.5rem 1rem;
            background: #000;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        .response {
            background: #f4f4f4;
            padding: 1rem;
            border-radius: 4px;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <div style="max-width: 800px; margin: 0 auto; padding: 20px; font-family: sans-serif;">
        <h1>üìö Motia PDF Chat</h1>

        <div style="background: #f4f4f4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3>1. Upload PDF</h3>
            <input type="file" id="fileInput" accept="application/pdf" />
            <button onclick="uploadFile()" style="padding: 10px 20px; background: #000; color: #fff; border: none; cursor: pointer;">
                Upload & Process
            </button>
            <div id="uploadStatus" style="margin-top: 10px; color: #555;"></div>
        </div>

        <div style="border: 1px solid #ddd; border-radius: 8px; height: 500px; display: flex; flex-direction: column;">
            
            <div id="chatContainer" style="flex: 1; overflow-y: auto; padding: 20px; background: #fff;">
                <div style="color: #888; text-align: center; margin-top: 100px;">
                    Upload a PDF to start chatting!
                </div>
            </div>

            <div style="padding: 20px; background: #f9f9f9; border-top: 1px solid #ddd; display: flex; gap: 10px;">
                <input type="text" id="questionInput" placeholder="Ask a question about the PDF..." 
                    style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px;"
                    onkeypress="if(event.key === 'Enter') askQuestion()">
                <button onclick="askQuestion()" 
                    style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Send
                </button>
            </div>
        </div>
    </div>
    <script>
        let currentFileId = null;
        let chatHistory = []; // STORE CONVERSATION HERE

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return alert("Please select a file");

            const status = document.getElementById('uploadStatus');
            status.innerText = "Initializing upload...";

            const fileId = crypto.randomUUID();
            currentFileId = fileId; 
            
            // RESET CHAT HISTORY ON NEW UPLOAD
            chatHistory = []; 
            document.getElementById('chatContainer').innerHTML = '<div style="color: #28a745; text-align: center; margin: 20px;">‚úÖ New PDF Ready! Ask away.</div>';

            const CHUNK_SIZE = 10 * 1024; 
            const totalChunks = Math.ceil(file.size / CHUNK_SIZE);

            try {
                for (let i = 0; i < totalChunks; i++) {
                    const start = i * CHUNK_SIZE;
                    const end = Math.min(file.size, start + CHUNK_SIZE);
                    const chunk = file.slice(start, end);
                    const base64 = await new Promise((r) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(chunk);
                        reader.onload = () => r(reader.result.split(',')[1]);
                    });

                    status.innerText = `Uploading chunk ${i + 1} of ${totalChunks}...`;
                    await fetch('/upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ fileId, fileName: file.name, chunkIndex: i, totalChunks, dataBase64: base64 })
                    });
                }
                status.innerText = "‚úÖ Upload Complete! (ID: " + fileId + ")";
            } catch (e) {
                console.error(e);
                status.innerText = "‚ùå Upload failed.";
            }
        }

        async function askQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            if (!question || !currentFileId) return;

            // 1. Add User Message to UI
            addMessageToUI('user', question);
            input.value = '';

            // 2. Add to History Object
            chatHistory.push({ role: 'user', content: question });

            // 3. Show Loading
            const loadingId = addMessageToUI('assistant', '<i>Thinking...</i>');

            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        messages: chatHistory, // SEND FULL HISTORY
                        fileId: currentFileId 
                    })
                });
                const data = await res.json();
                
                // 4. Update Assistant Message
                const answerDiv = document.getElementById(loadingId);
                answerDiv.innerHTML = data.answer;
                
                // Add Sources if available
                if (data.sources?.length) {
                    answerDiv.innerHTML += `<div style="margin-top:8px; font-size:0.85em; color:#666; border-left: 2px solid #ccc; padding-left: 8px;">
                        üìù Source: "${data.sources[0].metadata.text.substring(0, 100)}..."
                    </div>`;
                }

                // 5. Save to History
                chatHistory.push({ role: 'assistant', content: data.answer });

            } catch (e) {
                document.getElementById(loadingId).innerHTML = "‚ùå Error getting answer.";
            }
        }

        function addMessageToUI(role, text) {
            const container = document.getElementById('chatContainer');
            const id = 'msg-' + Date.now();
            const bg = role === 'user' ? '#007bff' : '#eee';
            const color = role === 'user' ? '#fff' : '#000';
            const align = role === 'user' ? 'flex-end' : 'flex-start';

            const html = `
                <div style="display: flex; justify-content: ${align}; margin-bottom: 10px;">
                    <div id="${id}" style="max-width: 70%; padding: 10px 15px; border-radius: 15px; background: ${bg}; color: ${color}; line-height: 1.4;">
                        ${text}
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            container.scrollTop = container.scrollHeight; // Auto-scroll
            return id;
        }
    </script>
</body>

</html>