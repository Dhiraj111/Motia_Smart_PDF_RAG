<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motia Smart PDF</title>
    <style>
        /* 1. Main Chat Area */
        #chatContainer {
            display: flex;
            flex-direction: column;
            gap: 25px;
            /* More breathing room between QA pairs */
            padding: 40px 20px;
            max-width: 900px;
            /* Keep text readable width */
            margin: 0 auto;
        }

        /* 2. The Row (Alignment) */
        .chat-row {
            display: flex;
            width: 100%;
        }

        .chat-row.user {
            justify-content: flex-end;
        }

        .chat-row.assistant {
            justify-content: flex-start;
        }

        /* 3. GEMINI STYLE BUBBLES */

        /* USER: Keep a subtle pill shape (like Gemini/ChatGPT) */
        .chat-bubble.user {
            background-color: #f0f4f9;
            /* Very light blue-gray */
            color: #1f1f1f;
            padding: 10px 20px;
            border-radius: 24px;
            /* Fully rounded pill */
            max-width: 70%;
            font-family: 'Google Sans', sans-serif;
            /* Optional: looks nicer */
            font-size: 16px;
            line-height: 1.5;
        }

        /* ASSISTANT: NO background, just clean text */
        .chat-bubble.assistant {
            background-color: transparent;
            /* Invisible background */
            box-shadow: none;
            /* No shadow */
            padding: 0;
            /* No padding needed */
            color: #000;
            width: 100%;
            /* Let text expand nicely */
            max-width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            /* Better reading spacing */
            white-space: pre-wrap;
        }

        /* Add a little icon or label for the AI (Optional polish) */
        .chat-bubble.assistant::before {
            content: "‚ú® AI Answer";
            display: block;
            font-size: 12px;
            font-weight: bold;
            color: #6e6e6e;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>

<body>
    <div style="max-width: 800px; margin: 0 auto; padding: 20px; font-family: sans-serif;">
        <h1>üìö Motia PDF Chat</h1>

        <div style="background: #f4f4f4; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3>1. Upload PDF</h3>
            <input type="file" id="fileInput" accept="application/pdf" />
            <button onclick="uploadFile()"
                style="padding: 10px 20px; background: #000; color: #fff; border: none; cursor: pointer;">
                Upload & Process
            </button>
            <div id="uploadStatus" style="margin-top: 10px; color: #555;"></div>
        </div>

        <div style="border: 1px solid #ddd; border-radius: 8px; height: 500px; display: flex; flex-direction: column;">

            <div id="chatContainer" style="flex: 1; overflow-y: auto; padding: 20px; background: #fff;">
                <div style="color: #888; text-align: center; margin-top: 100px;">
                    Upload a PDF to start chatting!
                </div>
            </div>

            <div style="padding: 20px; background: #f9f9f9; border-top: 1px solid #ddd; display: flex; gap: 10px;">
                <input type="text" id="questionInput" placeholder="Ask a question about the PDF..."
                    style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px;"
                    onkeypress="if(event.key === 'Enter') askQuestion()">
                <button onclick="askQuestion()"
                    style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Send
                </button>
            </div>
        </div>
    </div>
    <script>
        let currentFileId = null;
        let chatHistory = [];

        // --- UPLOAD FUNCTION (Kept same as before) ---
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return alert("Please select a file");

            const status = document.getElementById('uploadStatus');
            status.innerText = "Initializing upload...";

            const fileId = crypto.randomUUID();
            currentFileId = fileId;

            chatHistory = []; // Reset history
            document.getElementById('chatContainer').innerHTML = `
            <div style="text-align: center; color: #28a745; margin-top: 20px;">
                ‚úÖ New PDF Ready! Ask away.
            </div>`;

            const CHUNK_SIZE = 1 * 1024 * 1024; // 1MB
            const totalChunks = Math.ceil(file.size / CHUNK_SIZE);

            try {
                for (let i = 0; i < totalChunks; i++) {
                    const start = i * CHUNK_SIZE;
                    const end = Math.min(file.size, start + CHUNK_SIZE);
                    const chunk = file.slice(start, end);
                    const base64 = await new Promise((r) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(chunk);
                        reader.onload = () => r(reader.result.split(',')[1]);
                    });

                    if (i % 5 === 0 || i === totalChunks - 1) {
                        status.innerText = `Uploading chunk ${i + 1} of ${totalChunks}...`;
                    }

                    await fetch('/upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ fileId, fileName: file.name, chunkIndex: i, totalChunks, dataBase64: base64 })
                    });
                }
                status.innerText = "‚úÖ Upload Complete!";
            } catch (e) {
                console.error(e);
                status.innerText = "‚ùå Upload failed.";
            }
        }

        // --- NEW CLEAN UI FUNCTION ---
        function addMessageToUI(role, text) {
            const container = document.getElementById('chatContainer');
            const id = 'msg-' + Date.now() + Math.random();

            // Use CSS classes instead of inline styles
            const rowClass = role === 'user' ? 'user' : 'assistant';
            const bubbleClass = role === 'user' ? 'user' : 'assistant';

            const html = `
            <div class="chat-row ${rowClass}">
                <div id="${id}" class="chat-bubble ${bubbleClass}">
                    ${text}
                </div>
            </div>
        `;

            container.insertAdjacentHTML('beforeend', html);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        // --- ASK QUESTION (Without Source Text) ---
        async function askQuestion() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            if (!question || !currentFileId) return;

            input.value = '';

            // 1. Show User Message
            addMessageToUI('user', question);
            chatHistory.push({ role: 'user', content: question });

            // 2. Show Loading Bubble
            const loadingId = addMessageToUI('assistant', '<i>Thinking...</i>');

            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: chatHistory,
                        fileId: currentFileId
                    })
                });
                const data = await res.json();

                // 3. Update the Bubble with ONLY the answer
                const answerDiv = document.getElementById(loadingId);
                if (answerDiv) {
                    answerDiv.innerHTML = data.answer;
                    // NOTE: I removed the "Source" appending code here.
                }

                chatHistory.push({ role: 'assistant', content: data.answer });

            } catch (e) {
                console.error(e);
                const errorDiv = document.getElementById(loadingId);
                if (errorDiv) errorDiv.innerHTML = "‚ùå Error getting answer.";
            }
        }
    </script>
</body>

</html>